name: Installer Script Checks

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'scripts/install_*.sh'
      - 'scripts/smoke_test_vllm.sh'
      - 'scripts/vllm_compat.json'
      - 'scripts/_resolve_compat.py'
      - 'tests/test_vllm_compat_resolver.py'
      - '.github/workflows/installer-checks.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'scripts/install_*.sh'
      - 'scripts/smoke_test_vllm.sh'
      - 'scripts/vllm_compat.json'
      - 'scripts/_resolve_compat.py'
      - 'tests/test_vllm_compat_resolver.py'
      - '.github/workflows/installer-checks.yml'

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
          ignore_paths: |
            scripts/third_party
            scripts/vendor

  syntax-check:
    name: Bash Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check install_agent.sh syntax
        run: bash -n scripts/install_agent.sh

      - name: Check install_central.sh syntax
        run: bash -n scripts/install_central.sh

      - name: Check smoke_test_vllm.sh syntax
        run: bash -n scripts/smoke_test_vllm.sh

  dry-run-test:
    name: Dry Run Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dry run install_agent.sh (no-vllm)
        run: |
          bash scripts/install_agent.sh --dry-run --yes \
            --no-vllm \
            --agent-id "test-agent" \
            --label "Test Agent" \
            --central-url "http://localhost:8080" \
            --skip-ollama \
            --skip-comfyui

      - name: Dry run install_agent.sh (with vllm, skip-service)
        run: |
          bash scripts/install_agent.sh --dry-run --yes \
            --vllm-version 0.15.1 \
            --agent-id "test-agent" \
            --label "Test Agent" \
            --skip-service \
            --skip-ollama \
            --skip-comfyui

      - name: Dry run install_central.sh
        run: |
          bash scripts/install_central.sh --dry-run --yes

  resolver-dry-run:
    name: Compat Resolver Dry Run
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Resolver – linux-x86_64 no CUDA
        env:
          BENCH_RACE_ARCH_PLATFORM: linux-x86_64
          BENCH_RACE_CUDA_VERSION: ""
        run: python3 scripts/_resolve_compat.py

      - name: Resolver – linux-x86_64 CUDA 12.1
        env:
          BENCH_RACE_ARCH_PLATFORM: linux-x86_64
          BENCH_RACE_CUDA_VERSION: "12.1"
        run: python3 scripts/_resolve_compat.py

      - name: Resolver – linux-x86_64 CUDA 12.8
        env:
          BENCH_RACE_ARCH_PLATFORM: linux-x86_64
          BENCH_RACE_CUDA_VERSION: "12.8"
        run: python3 scripts/_resolve_compat.py

      - name: Resolver – linux-x86_64 CUDA 13.0 (GB10/Blackwell)
        env:
          BENCH_RACE_ARCH_PLATFORM: linux-x86_64
          BENCH_RACE_CUDA_VERSION: "13.0"
        run: python3 scripts/_resolve_compat.py

      - name: Resolver – linux-aarch64 no CUDA
        env:
          BENCH_RACE_ARCH_PLATFORM: linux-aarch64
          BENCH_RACE_CUDA_VERSION: ""
        run: python3 scripts/_resolve_compat.py

      - name: Resolver – linux-aarch64 CUDA 12.8 (GB10 aarch64)
        env:
          BENCH_RACE_ARCH_PLATFORM: linux-aarch64
          BENCH_RACE_CUDA_VERSION: "12.8"
        run: python3 scripts/_resolve_compat.py

      - name: Resolver – linux-aarch64 CUDA 13.0 (GB10 aarch64 CUDA>=13)
        env:
          BENCH_RACE_ARCH_PLATFORM: linux-aarch64
          BENCH_RACE_CUDA_VERSION: "13.0"
        run: python3 scripts/_resolve_compat.py

      - name: Resolver – macos-arm64
        env:
          BENCH_RACE_ARCH_PLATFORM: macos-arm64
          BENCH_RACE_CUDA_VERSION: ""
        run: python3 scripts/_resolve_compat.py

      - name: Resolver – dry-run installer with resolved platform env vars
        env:
          BENCH_RACE_ARCH_PLATFORM: linux-x86_64
          BENCH_RACE_CUDA_VERSION: "12.8"
        run: |
          bash scripts/install_agent.sh --dry-run --yes \
            --agent-id test-resolver-ci \
            --skip-service \
            --skip-ollama \
            --skip-comfyui

  vllm-compat:
    name: vLLM Compat Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify vllm_compat.json exists
        run: test -f scripts/vllm_compat.json

      - name: Validate vllm_compat.json is valid JSON
        run: python3 -m json.tool scripts/vllm_compat.json >/dev/null

      - name: Check vllm_compat.json flat mappings have required keys
        run: |
          python3 -c "
          import json, sys
          with open('scripts/vllm_compat.json') as f:
              data = json.load(f)
          mappings = data.get('mappings', {})
          assert len(mappings) > 0, 'vllm_compat.json must have at least one flat mapping entry'
          for ver, m in mappings.items():
              assert 'setuptools' in m, f'mapping {ver} missing setuptools key'
              assert 'torch' in m, f'mapping {ver} missing torch key'
              print(f'  OK: {ver} -> setuptools={m[\"setuptools\"]}, torch={m[\"torch\"]}')
          print(f'{len(mappings)} flat mapping(s) validated')
          "

      - name: Check vllm_compat.json platform_mappings structure
        run: |
          python3 -c "
          import json, sys
          with open('scripts/vllm_compat.json') as f:
              data = json.load(f)
          pm = data.get('platform_mappings', {})
          assert len(pm) >= 2, 'platform_mappings must have at least 2 platforms'
          required_keys = {'torch', 'vllm', 'setuptools', 'torch_tag'}
          for plat, entries in pm.items():
              assert isinstance(entries, list), f'{plat}: entries must be a list'
              assert len(entries) >= 1, f'{plat}: must have at least one entry'
              has_cpu_fallback = any(e.get('cuda_min') is None for e in entries)
              assert has_cpu_fallback, f'{plat}: missing CPU fallback entry (cuda_min=null)'
              for i, e in enumerate(entries):
                  for k in required_keys:
                      assert k in e, f'{plat}[{i}] missing required key {k!r}'
              print(f'  OK: {plat} ({len(entries)} entries)')
          print(f'{len(pm)} platform(s) validated')
          "

      - name: Check schema_version in vllm_compat.json
        run: |
          python3 -c "
          import json
          with open('scripts/vllm_compat.json') as f:
              data = json.load(f)
          assert data.get('meta', {}).get('schema_version') == 2, 'Expected schema_version 2'
          print('schema_version=2 OK')
          "

      - name: Verify deterministic install helpers present in installer
        run: |
          grep -q '_vllm_compat_lookup' scripts/install_agent.sh
          grep -q '_try_install_vllm_deterministic' scripts/install_agent.sh
          grep -q 'resolve_vllm_compat' scripts/install_agent.sh
          grep -q '_install_torch_from_resolved' scripts/install_agent.sh
          grep -q '_pip_check_with_fixup' scripts/install_agent.sh
          echo "All required installer functions present"

      - name: Verify _resolve_compat.py exists and is syntactically valid
        run: |
          test -f scripts/_resolve_compat.py
          python3 -m py_compile scripts/_resolve_compat.py
          echo "_resolve_compat.py syntax OK"

  resolver-unit-tests:
    name: Resolver Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install test dependencies
        run: pip3 install pytest --quiet

      - name: Run compat resolver unit tests
        run: python3 -m pytest tests/test_vllm_compat_resolver.py -v

  macos-syntax:
    name: macOS Compatibility Check
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check install_agent.sh syntax on macOS
        run: bash -n scripts/install_agent.sh

      - name: Check install_central.sh syntax on macOS
        run: bash -n scripts/install_central.sh

      - name: Verify help output (agent)
        run: bash scripts/install_agent.sh --help

      - name: Verify help output (central)
        run: bash scripts/install_central.sh --help

      - name: Resolver – macos-arm64 on macOS runner
        env:
          BENCH_RACE_ARCH_PLATFORM: macos-arm64
          BENCH_RACE_CUDA_VERSION: ""
        run: python3 scripts/_resolve_compat.py
