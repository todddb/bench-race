name: Installer Script Checks

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'scripts/install_*.sh'
      - 'scripts/smoke_test_vllm.sh'
      - 'scripts/vllm_compat.json'
      - '.github/workflows/installer-checks.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'scripts/install_*.sh'
      - 'scripts/smoke_test_vllm.sh'
      - 'scripts/vllm_compat.json'
      - '.github/workflows/installer-checks.yml'

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
          ignore_paths: |
            scripts/third_party
            scripts/vendor

  syntax-check:
    name: Bash Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check install_agent.sh syntax
        run: bash -n scripts/install_agent.sh

      - name: Check install_central.sh syntax
        run: bash -n scripts/install_central.sh

  dry-run-test:
    name: Dry Run Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dry run install_agent.sh
        run: |
          bash scripts/install_agent.sh --dry-run --yes \
            --agent-id "test-agent" \
            --label "Test Agent" \
            --central-url "http://localhost:8080" \
            --skip-ollama \
            --skip-comfyui

      - name: Dry run install_central.sh
        run: |
          bash scripts/install_central.sh --dry-run --yes

  vllm-compat:
    name: vLLM Compat Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify vllm_compat.json exists
        run: test -f scripts/vllm_compat.json

      - name: Validate vllm_compat.json is valid JSON
        run: python3 -m json.tool scripts/vllm_compat.json >/dev/null

      - name: Check vllm_compat.json has at least one mapping
        run: |
          python3 -c "
          import json, sys
          with open('scripts/vllm_compat.json') as f:
              data = json.load(f)
          mappings = data.get('mappings', {})
          assert len(mappings) > 0, 'vllm_compat.json must have at least one mapping entry'
          for ver, m in mappings.items():
              assert 'setuptools' in m, f'mapping {ver} missing setuptools key'
              assert 'torch' in m, f'mapping {ver} missing torch key'
              print(f'  OK: {ver} -> setuptools={m[\"setuptools\"]}, torch={m[\"torch\"]}')
          print(f'{len(mappings)} mapping(s) validated')
          "

      - name: Verify deterministic install helpers present
        run: |
          grep -q '_vllm_compat_lookup' scripts/install_agent.sh
          grep -q '_try_install_vllm_deterministic' scripts/install_agent.sh

      - name: Check smoke_test_vllm.sh syntax
        run: bash -n scripts/smoke_test_vllm.sh

  macos-syntax:
    name: macOS Compatibility Check
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check install_agent.sh syntax on macOS
        run: bash -n scripts/install_agent.sh

      - name: Check install_central.sh syntax on macOS
        run: bash -n scripts/install_central.sh

      - name: Verify help output (agent)
        run: bash scripts/install_agent.sh --help

      - name: Verify help output (central)
        run: bash scripts/install_central.sh --help
