<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>bench-race ¬∑ image</title>
    <link rel="stylesheet" href="/static/css/app.css" />
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  </head>
  <body>
    <div class="container">
      <header class="app-header">
        <h1 class="app-title">Generative AI Benchmark Race</h1>
        <div class="app-actions">
          <nav class="app-nav" aria-label="Benchmark modes">
            <a class="nav-link" href="/inference">Inference</a>
            <a class="nav-link active" href="/image">Image</a>
          </nav>
          <div id="run-active-indicator" title="No active runs"></div>
          <button id="btn-history" class="icon-button" type="button" aria-label="Recent Runs" title="Recent Runs">
            <span class="icon" aria-hidden="true">üïí</span>
            <span id="history-count" class="icon-badge hidden" aria-hidden="true">0</span>
          </button>
          <button id="btn-settings" class="icon-button" type="button" aria-label="Settings" title="Settings">
            <span class="icon" aria-hidden="true">‚öôÔ∏è</span>
          </button>
        </div>
      </header>

      <div class="main-layout">
        <div class="main-content">
          <div class="controls card">
            <div class="controls-grid">
              <div class="controls-columns">
                <div class="controls-left">
                  <div class="prompt-section">
                    <div class="prompt-header">
                      <label for="prompt" class="control-label">Prompt</label>
                    </div>
                    <textarea id="prompt" class="prompt" rows="6">A cinematic portrait of a futuristic city at sunrise, ultra-detailed, volumetric light.</textarea>
                    <div class="prompt-helper helper">
                      SDXL text-to-image prompt used across all agents.
                    </div>
                  </div>

                  <div class="run-row">
                    <div class="run-actions-left">
                      <button id="run" class="btn btn-primary">Run</button>
                      <button id="refresh-caps" class="btn btn-secondary" title="Refresh checkpoints">Refresh</button>
                    </div>
                  </div>
                </div>

                <div class="controls-right">
                  <div class="model-row control-field">
                    <label for="checkpoint" class="control-label">Checkpoint</label>
                    <select id="checkpoint">
                      {% for checkpoint in checkpoint_options %}
                      <option value="{{ checkpoint }}">{{ checkpoint }}</option>
                      {% endfor %}
                    </select>
                    <div class="helper">Checkpoint to run on each machine.</div>
                  </div>
                  <div class="control-field">
                    <button id="sync-checkpoints" class="btn btn-secondary">Sync Checkpoints</button>
                  </div>

                  <button class="options-header options-toggle" id="options-toggle" type="button">
                    <span class="control-label">Options</span>
                    <span class="options-caret">‚ñ∂</span>
                  </button>
                  <div id="options-panel" class="options-grid">
                    <div class="control-field">
                      <label for="seed-mode" class="control-label">Seed Mode</label>
                      <select id="seed-mode">
                        <option value="fixed">Fixed</option>
                        <option value="random">Random</option>
                      </select>
                    </div>

                    <div class="control-field">
                      <label for="seed" class="control-label">Seed</label>
                      <input id="seed" type="number" value="12345" />
                    </div>

                    <div class="control-field">
                      <label for="steps" class="control-label">Steps</label>
                      <input id="steps" type="number" value="30" />
                    </div>

                    <div class="control-field">
                      <label for="resolution" class="control-label">Resolution</label>
                      <select id="resolution">
                        <option value="512x512">512x512</option>
                        <option value="768x768">768x768</option>
                        <option value="1024x1024" selected>1024x1024</option>
                        <option value="1152x896">1152x896</option>
                        <option value="1344x768">1344x768</option>
                        <option value="1536x640">1536x640</option>
                      </select>
                    </div>

                    <div class="control-field">
                      <label for="num-images" class="control-label">Num Images</label>
                      <input id="num-images" type="number" value="1" />
                    </div>

                    <div class="control-field">
                      <label for="repeat" class="control-label">Repeat</label>
                      <input id="repeat" type="number" value="1" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="preflight-banner" class="preflight-banner hidden"></div>
            <div id="status"></div>
          </div>

          <div id="run-view-banner" class="run-view-banner hidden">
            <div class="run-view-main">
              <div class="run-view-title" id="run-view-title"></div>
              <div class="run-view-subtitle" id="run-view-subtitle"></div>
            </div>
            <div class="run-view-actions">
              <button id="run-view-return" class="btn-secondary btn-small">Return to live</button>
            </div>
          </div>

          <div class="grid image-grid">
            {% for m in machines %}
            <div class="pane card image-pane" id="pane-{{ m.machine_id }}">
              <div class="pane-header">
                <div class="pane-header-main">
                  <div class="pane-title">{{ m.label }}</div>
                  <div class="model-fit" id="model-fit-{{ m.machine_id }}">Checkpoint: --</div>
                </div>
                <div class="pane-status">
                  {% if m.agent_reachable is defined and m.agent_reachable == true %}
                  <span class="status-dot ready" id="status-dot-{{ m.machine_id }}" title="Online"></span>
                  <span class="status-text" id="status-text-{{ m.machine_id }}">Online</span>
                  {% elif m.agent_reachable is defined and m.agent_reachable == false %}
                  <span class="status-dot offline" id="status-dot-{{ m.machine_id }}" title="Offline"></span>
                  <span class="status-text" id="status-text-{{ m.machine_id }}">Offline</span>
                  {% else %}
                  <span class="status-dot checking" id="status-dot-{{ m.machine_id }}" title="Checking..."></span>
                  <span class="status-text" id="status-text-{{ m.machine_id }}">Checking...</span>
                  {% endif %}
                  <button class="btn btn-sync hidden" id="sync-{{ m.machine_id }}">Sync Checkpoints</button>
                </div>
              </div>
              <div class="image-preview">
                <img id="preview-{{ m.machine_id }}" class="preview-image" alt="Preview" />
              </div>
              <div class="metrics" id="metrics-{{ m.machine_id }}">
                <span class="muted">Waiting‚Ä¶</span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <div id="history-overlay" class="overlay hidden" aria-hidden="true">
      <div class="overlay-backdrop" data-overlay-close="history"></div>
      <aside class="drawer drawer-right" role="dialog" aria-modal="true" aria-labelledby="history-title">
        <header class="drawer-header">
          <div>
            <h3 id="history-title">Recent Runs</h3>
            <p class="drawer-subtitle">Click a run to view results.</p>
          </div>
          <button class="icon-button close-drawer" type="button" data-overlay-close="history" aria-label="Close recent runs">‚úï</button>
        </header>
        <div class="drawer-body">
          <div class="drawer-actions">
            <button id="refresh-runs" class="btn-secondary btn-small" type="button">Refresh</button>
          </div>
          <div id="recent-runs-list" class="recent-runs-list"></div>
        </div>
      </aside>
    </div>

    <div id="settings-overlay" class="overlay hidden" aria-hidden="true">
      <div class="overlay-backdrop" data-overlay-close="settings"></div>
      <aside class="drawer drawer-right" role="dialog" aria-modal="true" aria-labelledby="settings-title">
        <header class="drawer-header">
          <div>
            <h3 id="settings-title">Settings</h3>
            <p class="drawer-subtitle">Manage model policy and ComfyUI cache.</p>
          </div>
          <button class="icon-button close-drawer" type="button" data-overlay-close="settings" aria-label="Close settings">‚úï</button>
        </header>
        <div class="drawer-body">
          <div class="drawer-section">
            <label for="model-policy-editor" class="control-label">Model Policy (central source of truth)</label>
            <div class="help-text">One model per line. Example: llama3.1:8b-instruct-q8_0</div>
            <textarea id="model-policy-editor" class="settings-textarea" rows="10"></textarea>
            <div id="model-policy-error" class="form-error hidden" role="alert"></div>
            <div id="model-policy-summary" class="helper hidden"></div>
          </div>
          <div class="drawer-section">
            <h4 class="drawer-section-title">ComfyUI</h4>
            <label for="comfy-base-url" class="control-label">ComfyUI Base URL</label>
            <input id="comfy-base-url" type="text" placeholder="http://agent-host:8188" />
            <label for="comfy-models-path" class="control-label">ComfyUI Models Path</label>
            <input id="comfy-models-path" type="text" placeholder="/opt/comfyui/models/checkpoints" />
            <label for="comfy-cache-path" class="control-label">Central Checkpoint Cache Path</label>
            <input id="comfy-cache-path" type="text" placeholder="central/model_cache/comfyui" />
            <label for="comfy-checkpoints" class="control-label">Checkpoint URL List</label>
            <div class="help-text">One URL per line. Optional |sha256 after URL.</div>
            <textarea id="comfy-checkpoints" class="settings-textarea" rows="6"></textarea>
            <div class="checkpoint-validation">
              <div class="checkpoint-validation-header">
                <span class="helper">Validation status</span>
                <button id="recheck-checkpoints" class="btn btn-secondary btn-small" type="button">Re-check</button>
              </div>
              <div id="checkpoint-validation-list" class="checkpoint-validation-list"></div>
            </div>
          </div>
          <div class="drawer-section">
            <h4 class="drawer-section-title">Performance</h4>
            <div class="polling-settings">
              <div class="setting-row">
                <label class="setting-label" for="enable-live-preview">Enable Live Preview</label>
                <input type="checkbox" class="setting-checkbox" id="enable-live-preview" checked />
              </div>
              <div class="setting-helper">Disable to reduce CPU/GPU load during generation. Final images always show.</div>
              <div class="setting-row">
                <label class="setting-label" for="idle-poll-interval">Idle Poll Interval (s)</label>
                <input type="number" class="setting-input" id="idle-poll-interval" value="30" min="5" max="120" />
              </div>
              <div class="setting-row">
                <label class="setting-label" for="active-poll-interval">Active Poll Interval (ms)</label>
                <input type="number" class="setting-input" id="active-poll-interval" value="2000" min="500" max="10000" />
              </div>
              <div class="setting-row">
                <label class="setting-label" for="preview-throttle">Preview Throttle (ms)</label>
                <input type="number" class="setting-input" id="preview-throttle" value="1000" min="100" max="5000" />
              </div>
              <div class="setting-helper">Lower values show more preview frames but use more resources.</div>
            </div>
          </div>
        </div>
        <footer class="drawer-footer">
          <button id="settings-cancel" class="btn btn-secondary" type="button">Cancel</button>
          <button id="settings-save" class="btn btn-primary" type="button">Save</button>
        </footer>
      </aside>
    </div>

    <script src="/static/js/image.js"></script>
  </body>
</html>
