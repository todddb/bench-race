<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>bench-race ¬∑ compute</title>
    <link rel="stylesheet" href="/static/css/app.css?v={{ build_id }}" />
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  </head>
  <body data-mode="compute">
    <div class="container">
      <header class="app-header">
        <h1 class="app-title">Generative AI Benchmark Race</h1>
        <div class="app-actions">
          <nav class="app-nav" aria-label="Benchmark modes">
            <a class="nav-link active" href="/compute">Compute</a>
            <a class="nav-link" href="/inference">Inference</a>
            <a class="nav-link" href="/image">Image</a>
          </nav>
          <div id="run-active-indicator" title="No active runs"></div>
          <button id="btn-history" class="icon-button" type="button" aria-label="Recent Runs" title="Recent Runs">
            <span class="icon" aria-hidden="true">üïí</span>
            <span id="history-count" class="icon-badge hidden" aria-hidden="true">0</span>
          </button>
          <button id="btn-settings" class="icon-button" type="button" aria-label="Settings (manage central model policy)" title="Settings">
            <span class="icon" aria-hidden="true">‚öôÔ∏è</span>
          </button>
        </div>
      </header>

      <div class="main-layout">
        <div class="main-content">
          <div class="controls card">
            <div class="controls-grid">
              <div class="controls-columns">
                <div class="controls-left">
                  <div class="prompt-section">
                    <div class="prompt-header">
                      <label for="compute-algorithm" class="control-label">Compute parameters</label>
                    </div>
                    <div class="compute-params">
                      <div class="compute-params-row compute-params-row-top">
                        <div class="control-field">
                          <label for="compute-algorithm" class="control-label">Algorithm</label>
                          <select id="compute-algorithm">
                            <option value="segmented_sieve" selected>Segmented Sieve (default)</option>
                            <option value="simple_sieve">Simple Sieve</option>
                            <option value="trial_division">Trial Division (slow)</option>
                          </select>
                        </div>
                        <div class="control-field">
                          <label for="compute-n" class="control-label">Count primes ‚â§ N</label>
                          <input id="compute-n" type="number" min="10" value="100000000" />
                        </div>
                        <div class="control-field control-field-auto">
                          <label for="compute-n-recommended" class="control-label">Auto</label>
                          <button id="compute-n-recommended" class="btn btn-secondary btn-small" type="button">Auto</button>
                        </div>
                      </div>
                      <div class="compute-params-row compute-params-row-bottom">
                        <div class="control-field">
                          <label for="compute-threads" class="control-label">Threads</label>
                          <input id="compute-threads" type="number" min="1" value="1" />
                        </div>
                        <div class="control-field">
                          <label for="compute-repeat" class="control-label">Repeats</label>
                          <input id="compute-repeat" type="number" min="1" value="1" />
                        </div>
                      </div>
                    </div>
                    <div class="prompt-helper helper">
                      Counts primes up to N. Higher N increases runtime.
                    </div>
                  </div>

                  <div class="run-row">
                    <div class="run-actions-left">
                      <button id="run" class="btn btn-primary">Start</button>
                      <button id="refresh-caps" class="btn btn-secondary" title="Refresh capabilities">Refresh</button>
                    </div>
                  </div>
                </div>

                <div class="controls-right">
                  <button class="options-header options-toggle" id="options-toggle" type="button">
                    <span class="control-label">Notes</span>
                    <span class="options-caret">‚ñ∂</span>
                  </button>
                  <div id="options-panel" class="options-grid">
                    <div class="control-field">
                      <label class="control-label">About compute</label>
                      <div class="helper">Compute mode benchmarks CPU prime counting. GPU metrics remain visible for parity.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="preflight-banner" class="preflight-banner hidden"></div>
            <div id="status"></div>
          </div>

          <div id="run-view-banner" class="run-view-banner hidden">
            <div class="run-view-main">
              <div class="run-view-title" id="run-view-title"></div>
              <div class="run-view-subtitle" id="run-view-subtitle"></div>
              <div id="run-warning-banner" class="run-warning-banner hidden">Mock engine used on one or more machines.</div>
            </div>
            <div class="run-view-actions">
              <button id="run-view-return" class="btn-secondary btn-small">Return to live</button>
              <button id="run-view-pin" class="btn-secondary btn-small">Pin as baseline</button>
              <button id="run-view-export-csv" class="btn-secondary btn-small">Export CSV</button>
              <button id="run-view-export-json" class="btn-secondary btn-small">Export JSON</button>
            </div>
          </div>

          <div class="grid">
            {% for m in machines %}
            <div class="pane card {% if m.excluded %}pane-excluded{% endif %}" id="pane-{{ m.machine_id }}" data-excluded="{{ m.excluded|lower }}" data-vendor="{{ m.vendor|default('other') }}">
              <div class="pane-header">
                <img class="vendor-logo" id="vendor-logo-{{ m.machine_id }}" src="/static/assets/vendor/{{ m.vendor|default('other') }}.png" alt="{{ m.vendor|default('other') }} logo" title="{{ m.vendor|default('other')|title }}" />
                <div class="pane-title">{{ m.label }}</div>
                <div class="pane-status">
                  <span class="status-badge {% if m.agent_reachable is defined and m.agent_reachable == true %}ready{% elif m.agent_reachable is defined and m.agent_reachable == false %}offline{% else %}checking{% endif %} {% if m.excluded %}standby{% endif %}" id="status-badge-{{ m.machine_id }}">
                    <span class="status-dot"></span>
                    <span class="status-text">
                      {% if m.excluded %}
                      Standby
                      {% elif m.agent_reachable is defined and m.agent_reachable == true %}
                      Ready
                      {% elif m.agent_reachable is defined and m.agent_reachable == false %}
                      Offline
                      {% else %}
                      Checking
                      {% endif %}
                    </span>
                  </span>
                </div>
                <div class="model-fit" id="model-fit-{{ m.machine_id }}">
                  <span class="fit-badge">FIT: --</span>
                  <span class="fit-score"></span>
                </div>
                <div class="pane-controls">
                  <button
                    class="btn btn-reset"
                    id="reset-{{ m.machine_id }}"
                    data-machine-id="{{ m.machine_id }}"
                    title="Reset Agent (restart Ollama + ComfyUI)"
                  >
                    Reset
                  </button>
                  <label class="toggle-switch" title="{% if m.excluded %}Click to enable{% else %}Click to disable{% endif %}">
                    <input
                      type="checkbox"
                      class="toggle-exclude-input"
                      id="toggle-exclude-{{ m.machine_id }}"
                      data-machine-id="{{ m.machine_id }}"
                      {% if not m.excluded %}checked{% endif %}
                    />
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Enabled</span>
                  </label>
                  <button class="btn btn-sync hidden" id="sync-{{ m.machine_id }}">Sync Models</button>
                </div>
              </div>
              <div class="sync-progress hidden" id="sync-progress-{{ m.machine_id }}">
                <div class="progress-bar">
                  <div class="progress-fill" id="sync-progress-fill-{{ m.machine_id }}"></div>
                </div>
                <div class="progress-text" id="sync-progress-text-{{ m.machine_id }}">Preparing sync‚Ä¶</div>
                <ul class="progress-log" id="sync-progress-log-{{ m.machine_id }}"></ul>
              </div>
              <pre class="output" id="out-{{ m.machine_id }}"></pre>
              <div class="footer-row">
                <div class="metrics" id="metrics-{{ m.machine_id }}">
                  <span class="muted">Waiting‚Ä¶</span>
                </div>
                <div class="mini-sparklines" id="runtime-sparklines-{{ m.machine_id }}">
                  <div class="sparkline-block">
                    <div class="sparkline-label">
                      UTIL (%) <span class="sparkline-label-detail"><span class="cpu-label">CPU</span> / <span class="gpu-label">GPU</span></span>
                    </div>
                    <svg class="sparkline" id="sparkline-util-{{ m.machine_id }}" viewBox="0 0 120 24"></svg>
                    <div class="sparkline-placeholder" id="sparkline-util-placeholder-{{ m.machine_id }}">
                      Metrics unavailable
                    </div>
                  </div>
                  <div class="sparkline-block">
                    <div class="sparkline-label">MEM (%)</div>
                    <svg class="sparkline" id="sparkline-mem-{{ m.machine_id }}" viewBox="0 0 120 24"></svg>
                    <div class="sparkline-placeholder" id="sparkline-mem-placeholder-{{ m.machine_id }}">
                      Metrics unavailable
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

      </div>
    </div>

    <!-- Toast container for notifications -->
    <div class="toast-container" id="toast-container"></div>

    <div id="sparkline-overlay" class="overlay hidden" aria-hidden="true">
      <div class="overlay-backdrop" data-overlay-close="sparkline"></div>
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sparkline-modal-title">
        <header class="modal-header">
          <h3 id="sparkline-modal-title">Runtime Metrics</h3>
          <button class="icon-button close-drawer" type="button" data-overlay-close="sparkline" aria-label="Close">‚úï</button>
        </header>
        <div class="modal-body">
          <div class="modal-chart-label" id="sparkline-modal-label"></div>
          <svg id="sparkline-modal-chart" viewBox="0 0 480 120"></svg>
          <div class="modal-chart-meta" id="sparkline-modal-meta"></div>
        </div>
      </div>
    </div>

    <div id="history-overlay" class="overlay hidden" aria-hidden="true">
      <div class="overlay-backdrop" data-overlay-close="history"></div>
      <aside class="drawer drawer-right" role="dialog" aria-modal="true" aria-labelledby="history-title">
        <header class="drawer-header">
          <div>
            <h3 id="history-title">Recent Runs</h3>
            <p class="drawer-subtitle">Click a run to view results. Pin a run to use as baseline.</p>
          </div>
          <button class="icon-button close-drawer" type="button" data-overlay-close="history" aria-label="Close recent runs">‚úï</button>
        </header>
        <div class="drawer-body">
          <div class="drawer-actions">
            <button id="refresh-runs" class="btn-secondary btn-small" type="button">Refresh</button>
            <button id="toggle-select-mode" class="btn-secondary btn-small" type="button">Select</button>
            <button id="select-all-runs" class="btn-secondary btn-small hidden" type="button">Select All</button>
            <button id="delete-selected-runs" class="btn-danger btn-small hidden" type="button">Delete Selected</button>
            <button id="delete-all-runs" class="btn-danger btn-small" type="button">Delete All</button>
          </div>
          <div id="recent-runs-list" class="recent-runs-list"></div>
        </div>
      </aside>
    </div>

    <div id="settings-overlay" class="overlay hidden" aria-hidden="true">
      <div class="overlay-backdrop" data-overlay-close="settings"></div>
      <aside class="drawer drawer-right" role="dialog" aria-modal="true" aria-labelledby="settings-title">
        <header class="drawer-header">
          <div>
            <h3 id="settings-title">Settings</h3>
            <p class="drawer-subtitle">Manage model policy and ComfyUI cache.</p>
          </div>
          <button class="icon-button close-drawer" type="button" data-overlay-close="settings" aria-label="Close settings">‚úï</button>
        </header>
        <div class="drawer-body">
          <div class="drawer-section">
            <label for="model-policy-editor" class="control-label">Model Policy (central source of truth)</label>
            <div class="help-text">One model per line. Example: llama3.1:8b-instruct-q8_0</div>
            <textarea id="model-policy-editor" class="settings-textarea" rows="10"></textarea>
            <div id="model-policy-error" class="form-error hidden" role="alert"></div>
            <div id="model-policy-summary" class="helper hidden"></div>
          </div>
          <div class="drawer-section">
            <h4 class="drawer-section-title">ComfyUI</h4>
            <label for="comfy-base-url" class="control-label">ComfyUI Base URL</label>
            <input id="comfy-base-url" type="text" placeholder="http://agent-host:8188" />
            <label for="comfy-models-path" class="control-label">ComfyUI Models Path</label>
            <input id="comfy-models-path" type="text" placeholder="/opt/comfyui/models/checkpoints" />
            <label for="comfy-cache-path" class="control-label">Central Checkpoint Cache Path</label>
            <input id="comfy-cache-path" type="text" placeholder="central/model_cache/comfyui" />
            <label for="comfy-checkpoints" class="control-label">Checkpoint URL List</label>
            <div class="help-text">One URL per line. Optional |sha256 after URL.</div>
            <textarea id="comfy-checkpoints" class="settings-textarea" rows="6"></textarea>
            <div class="checkpoint-validation">
              <div class="checkpoint-validation-header">
                <span class="helper">Validation status</span>
                <button id="recheck-checkpoints" class="btn btn-secondary btn-small" type="button">Re-check</button>
              </div>
              <div id="checkpoint-validation-list" class="checkpoint-validation-list"></div>
            </div>
          </div>
          <div class="drawer-section">
            <h4 class="drawer-section-title">Performance</h4>
            <div class="polling-settings">
              <div class="setting-row">
                <label class="setting-label" for="idle-poll-interval">Idle Poll Interval (s)</label>
                <input type="number" class="setting-input" id="idle-poll-interval" value="30" min="5" max="120" />
              </div>
              <div class="setting-row">
                <label class="setting-label" for="active-poll-interval">Active Poll Interval (ms)</label>
                <input type="number" class="setting-input" id="active-poll-interval" value="2000" min="500" max="10000" />
              </div>
              <div class="setting-helper">Polling frequency when runs are active vs idle. Lower uses more resources.</div>
            </div>
          </div>
          <div class="drawer-section">
            <h4 class="drawer-section-title">Compute</h4>
            <div class="polling-settings">
              <div class="setting-row">
                <label class="setting-label" for="compute-auto-n-segmented">Auto N (Segmented Sieve)</label>
                <input type="number" class="setting-input" id="compute-auto-n-segmented" value="100000000" min="10" />
              </div>
              <div class="setting-row">
                <label class="setting-label" for="compute-auto-n-simple">Auto N (Simple Sieve)</label>
                <input type="number" class="setting-input" id="compute-auto-n-simple" value="40000000" min="10" />
              </div>
              <div class="setting-row">
                <label class="setting-label" for="compute-auto-n-trial">Auto N (Trial Division)</label>
                <input type="number" class="setting-input" id="compute-auto-n-trial" value="4000000" min="10" />
              </div>
              <div class="setting-row">
                <label class="setting-label" for="compute-progress-interval">Compute: progress update interval (s)</label>
                <input type="number" class="setting-input" id="compute-progress-interval" value="1" min="0.1" step="0.1" />
              </div>
              <div class="setting-helper">Auto N presets and progress cadence are saved per browser.</div>
            </div>
          </div>
        </div>
        <footer class="drawer-footer">
          <button id="settings-cancel" class="btn btn-secondary" type="button">Cancel</button>
          <button id="settings-save" class="btn btn-primary" type="button">Save</button>
        </footer>
      </aside>
    </div>

    <!-- Reset Diagnostics Modal -->
    <div id="reset-diagnostics-modal" class="modal hidden">
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Reset Diagnostics</h2>
          <button class="modal-close" id="reset-modal-close" title="Close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="diagnostics-summary">
            <div class="diagnostics-field">
              <strong>Agent:</strong> <span id="diag-agent-name">-</span>
            </div>
            <div class="diagnostics-field">
              <strong>Status:</strong> <span id="diag-status" class="status-badge">-</span>
            </div>
            <div class="diagnostics-field">
              <strong>Duration:</strong> <span id="diag-duration">-</span>
            </div>
          </div>

          <div class="diagnostics-section" id="diag-notes-section">
            <h3>Notes</h3>
            <ul id="diag-notes" class="diagnostics-notes"></ul>
          </div>

          <div class="diagnostics-section">
            <h3>Ollama</h3>
            <div class="diagnostics-details">
              <div class="diagnostics-field">
                <strong>Healthy:</strong> <span id="diag-ollama-healthy">-</span>
              </div>
              <div class="diagnostics-field">
                <strong>Time to Ready:</strong> <span id="diag-ollama-time">-</span>
              </div>
              <div class="diagnostics-field">
                <strong>Log File:</strong>
                <code id="diag-ollama-log" class="log-path">-</code>
                <button class="btn btn-sm btn-copy" data-copy-target="diag-ollama-log" title="Copy to clipboard">Copy</button>
              </div>
            </div>
            <details class="diagnostics-logs">
              <summary>Stdout/Stderr Output</summary>
              <div class="log-output">
                <pre id="diag-ollama-stdout"></pre>
                <pre id="diag-ollama-stderr" class="stderr"></pre>
              </div>
              <button class="btn btn-sm btn-copy" data-copy-target="diag-ollama-stdout" title="Copy stdout">Copy Stdout</button>
              <button class="btn btn-sm btn-copy" data-copy-target="diag-ollama-stderr" title="Copy stderr">Copy Stderr</button>
            </details>
          </div>

          <div class="diagnostics-section">
            <h3>ComfyUI</h3>
            <div class="diagnostics-details">
              <div class="diagnostics-field">
                <strong>Healthy:</strong> <span id="diag-comfyui-healthy">-</span>
              </div>
              <div class="diagnostics-field">
                <strong>Time to Ready:</strong> <span id="diag-comfyui-time">-</span>
              </div>
              <div class="diagnostics-field">
                <strong>Log File:</strong>
                <code id="diag-comfyui-log" class="log-path">-</code>
                <button class="btn btn-sm btn-copy" data-copy-target="diag-comfyui-log" title="Copy to clipboard">Copy</button>
              </div>
            </div>
            <details class="diagnostics-logs">
              <summary>Stdout/Stderr Output</summary>
              <div class="log-output">
                <pre id="diag-comfyui-stdout"></pre>
                <pre id="diag-comfyui-stderr" class="stderr"></pre>
              </div>
              <button class="btn btn-sm btn-copy" data-copy-target="diag-comfyui-stdout" title="Copy stdout">Copy Stdout</button>
              <button class="btn btn-sm btn-copy" data-copy-target="diag-comfyui-stderr" title="Copy stderr">Copy Stderr</button>
            </details>
          </div>

          <div class="diagnostics-section">
            <h3>Full JSON Response</h3>
            <pre id="diag-full-json" class="json-output"></pre>
            <button class="btn btn-sm btn-copy" data-copy-target="diag-full-json" title="Copy JSON">Copy JSON</button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="reset-modal-close-btn">Close</button>
        </div>
      </div>
    </div>

    <script src="/static/js/app.js?v={{ build_id }}"></script>
  </body>
</html>
