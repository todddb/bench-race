<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>bench-race</title>
    <link rel="stylesheet" href="/static/css/app.css" />
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>bench-race</h1>

      <div class="main-layout">
        <div class="main-content">
          <div class="controls card">
            <div class="controls-grid">
              <div class="model-row control-field">
                <label for="model" class="control-label">Model</label>
                <select id="model">
                  {% for model in model_options %}
                  <option value="{{ model }}">{{ model }}</option>
                  {% endfor %}
                </select>
                <div class="helper">Which model to run on each machine.</div>
              </div>

              <div class="controls-right">
                <div class="control-field">
                  <label for="max_tokens" class="control-label">Max tokens</label>
                  <input id="max_tokens" type="number" value="256" />
                  <div class="helper">Limits how long the response can be.</div>
                </div>

                <div class="control-field">
                  <label for="num_ctx" class="control-label">Context</label>
                  <input id="num_ctx" type="number" value="4096" />
                  <div class="helper">How much conversation/prompt can fit. Larger uses more memory.</div>
                </div>

                <div class="control-field">
                  <label for="temperature" class="control-label">Temperature</label>
                  <input id="temperature" type="number" step="0.1" value="0.2" />
                  <div class="helper">Higher = more creative, lower = more deterministic.</div>
                </div>

                <div class="control-field">
                  <label for="repeat" class="control-label">Repeats</label>
                  <input id="repeat" type="number" value="1" />
                  <div class="helper">Run multiple times; first run may be slower due to cold cache.</div>
                </div>
              </div>

              <div class="prompt-column">
                <label for="prompt" class="control-label">Prompt</label>
                <div class="prompt-desc">
                  Enter a real-world prompt. Prefer multi-part tasks that require reasoning or code generation ‚Äî these take longer and stress performance.
                </div>
                <div class="prompt-actions">
                  <button id="generate-sample" class="btn btn-secondary" type="button">Generate Sample</button>
                  <span class="helper">Creates a unique, realistic prompt intended to take some time to process.</span>
                </div>
                <textarea id="prompt" class="prompt" rows="6">Summarize the key tradeoffs between unified memory and discrete VRAM for local LLM inference.</textarea>
              </div>
            </div>

            <div class="run-row">
              <div class="run-actions-left">
                <button id="run">Run (LLM)</button>
                <button id="refresh-caps" class="btn-secondary" title="Refresh capabilities">‚Üª Refresh</button>
                <label class="toggle-label">
                  <input type="checkbox" id="run-only-ready" checked />
                  Run only ready machines
                </label>
              </div>
              <div class="run-actions-right">
                <button id="btn-history" class="icon-button" type="button" aria-label="Recent Runs" title="Recent Runs">
                  <span class="icon" aria-hidden="true">üïí</span>
                  <span id="history-count" class="icon-badge hidden" aria-hidden="true">0</span>
                </button>
                <button id="btn-settings" class="icon-button" type="button" aria-label="Settings (manage central model policy)" title="Settings">
                  <span class="icon" aria-hidden="true">‚öôÔ∏è</span>
                </button>
              </div>
            </div>
            <div id="preflight-banner" class="preflight-banner hidden"></div>
            <div id="status"></div>
          </div>

          <div id="run-view-banner" class="run-view-banner hidden">
            <div class="run-view-main">
              <div class="run-view-title" id="run-view-title"></div>
              <div class="run-view-subtitle" id="run-view-subtitle"></div>
              <div id="run-warning-banner" class="run-warning-banner hidden">Mock engine used on one or more machines.</div>
            </div>
            <div class="run-view-actions">
              <button id="run-view-return" class="btn-secondary btn-small">Return to live</button>
              <button id="run-view-pin" class="btn-secondary btn-small">Pin as baseline</button>
              <button id="run-view-export-csv" class="btn-secondary btn-small">Export CSV</button>
              <button id="run-view-export-json" class="btn-secondary btn-small">Export JSON</button>
            </div>
          </div>

          <div class="grid">
            {% for m in machines %}
            <div class="pane card" id="pane-{{ m.machine_id }}">
              <div class="pane-header">
                <div class="pane-header-main">
                  <div class="pane-title">{{ m.label }}</div>
                  <div class="model-fit" id="model-fit-{{ m.machine_id }}">Model Fit: --</div>
                </div>
                <div class="pane-status">
                  <span class="status-dot checking" id="status-dot-{{ m.machine_id }}" title="Checking..."></span>
                  <span class="status-text" id="status-text-{{ m.machine_id }}">Checking...</span>
                  <button class="btn btn-sync hidden" id="sync-{{ m.machine_id }}">Sync Models</button>
                </div>
              </div>
              <div class="sync-progress hidden" id="sync-progress-{{ m.machine_id }}">
                <div class="progress-bar">
                  <div class="progress-fill" id="sync-progress-fill-{{ m.machine_id }}"></div>
                </div>
                <div class="progress-text" id="sync-progress-text-{{ m.machine_id }}">Preparing sync‚Ä¶</div>
                <ul class="progress-log" id="sync-progress-log-{{ m.machine_id }}"></ul>
              </div>
              <pre class="output" id="out-{{ m.machine_id }}"></pre>
              <div class="metrics" id="metrics-{{ m.machine_id }}">
                <span class="muted">Waiting‚Ä¶</span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

      </div>
    </div>

    <!-- Toast container for notifications -->
    <div class="toast-container" id="toast-container"></div>

    <div id="history-overlay" class="overlay hidden" aria-hidden="true">
      <div class="overlay-backdrop" data-overlay-close="history"></div>
      <aside class="drawer drawer-right" role="dialog" aria-modal="true" aria-labelledby="history-title">
        <header class="drawer-header">
          <div>
            <h3 id="history-title">Recent Runs</h3>
            <p class="drawer-subtitle">Click a run to view results. Pin a run to use as baseline.</p>
          </div>
          <button class="icon-button close-drawer" type="button" data-overlay-close="history" aria-label="Close recent runs">‚úï</button>
        </header>
        <div class="drawer-body">
          <div class="drawer-actions">
            <button id="refresh-runs" class="btn-secondary btn-small" type="button">Refresh</button>
          </div>
          <div id="recent-runs-list" class="recent-runs-list"></div>
        </div>
      </aside>
    </div>

    <div id="settings-overlay" class="overlay hidden" aria-hidden="true">
      <div class="overlay-backdrop" data-overlay-close="settings"></div>
      <aside class="drawer drawer-right" role="dialog" aria-modal="true" aria-labelledby="settings-title">
        <header class="drawer-header">
          <div>
            <h3 id="settings-title">Settings</h3>
            <p class="drawer-subtitle">Manage the central model policy.</p>
          </div>
          <button class="icon-button close-drawer" type="button" data-overlay-close="settings" aria-label="Close settings">‚úï</button>
        </header>
        <div class="drawer-body">
          <div class="drawer-section">
            <label for="model-policy-editor" class="control-label">Model Policy (central source of truth)</label>
            <div class="helper">One model per line. Example: llama3.1:8b-instruct-q8_0</div>
            <textarea id="model-policy-editor" class="settings-textarea" rows="10"></textarea>
            <div id="model-policy-error" class="form-error hidden" role="alert"></div>
            <div id="model-policy-summary" class="helper hidden"></div>
          </div>
        </div>
        <footer class="drawer-footer">
          <button id="settings-cancel" class="btn-secondary" type="button">Cancel</button>
          <button id="settings-save" class="btn" type="button">Save</button>
        </footer>
      </aside>
    </div>

    <script src="/static/js/app.js"></script>
  </body>
</html>
